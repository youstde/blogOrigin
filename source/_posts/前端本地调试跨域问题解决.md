---
title: å‰ç«¯æœ¬åœ°è°ƒè¯•è·¨åŸŸé—®é¢˜è§£å†³
date: 2018-01-05 19:33:24
tags:
---

## `å†™åœ¨å‰é¢`

[ä¼ é€é—¨](http://blog.csdn.net/cjd6568358/article/details/51871039)

é¡¹ç›®å…¨å±€é…ç½®ï¼Œè¿™ä¸ªæ˜¯æ¥å£è¯·æ±‚å’Œç™»å½•è¯·æ±‚çš„host

```javascript
module.exports={
    apiHost: "//ssppre.adbaitai.com",//æ¥å£apihost
    loginApiHost: "//ssppre.adbaitai.com"//ç™»å½•å’ŒapiHoståŒºåˆ†å‡ºæ¥ä¸»è¦æ˜¯æœ¬åœ°ä»£ç†æ— æ³•å¤„ç†ç™»å½•é—®é¢˜
};
```

è€Œè¿™ä¸ªé¡¹ç›®çš„é¢„å‘hostæ˜¯`ssppre.adbaitai.com`

æˆ‘æœ¬åœ°é€šè¿‡Nginxé…åˆhostsç»‘å®šï¼Œåšäº†ä¸€ä¸ªåå‘ä»£ç†ï¼Œå°†`h6.ssppre.adbaitai.com`,ä»£ç†åˆ°`http://localhost:8084`

è¿™æ ·åšçš„ç›®çš„æ˜¯æƒ³åœ¨æœ¬åœ°èƒ½å¤Ÿè°ƒç”¨é¢„å‘çš„ç™»å½•æ¥å£ï¼Œå¦‚æœä¸åšè¿™å±‚ä»£ç†çš„è¯ï¼Œç›´æ¥`http://localhost:8084`æ‰“å¼€é¡¹ç›®æ˜¯ç§ä¸ä¸Šç™»å½•çš„cookieçš„ï¼Œå› ä¸ºè·¨åŸŸ

åšåˆ°è¿™ä¸€æ­¥åº”ç”¨æ˜¯æˆåŠŸç™»å½•äº†ï¼Œä½†æ˜¯åç»­çš„ä¸€äº›æ¥å£è¯·æ±‚æ˜¯æŠ¥é”™çš„ï¼Œå› ä¸ºæˆ‘æœ¬åœ°æ˜¯h6.ssppre.adbaitai.com,è€ŒapiHostæ˜¯//ssppre.adbaitai.comã€‚

![](http://ww1.sinaimg.cn/large/005QDhBjgy1fn5yzwu1wpj327y15ah3o.jpg)

åŒæ ·è¿˜æ˜¯è·¨åŸŸé—®é¢˜ï¼Œç°åœ¨è¦åšçš„æ˜¯å¯¹æ¥å£çš„è°ƒç”¨è¿›è¡Œä»£ç†

```javascript
module.exports={
    apiHost: "//h6.ssppre.adbaitai.com",//æ¥å£apihost
    loginApiHost: "//ssppre.adbaitai.com"//ç™»å½•å’ŒapiHoståŒºåˆ†å‡ºæ¥ä¸»è¦æ˜¯æœ¬åœ°ä»£ç†æ— æ³•å¤„ç†ç™»å½•é—®é¢˜
};
```

å¦‚ä¸Šï¼Œå°†apiHostæ”¹æˆæœ¬åœ°çš„ï¼Œç„¶åå†å°†Nginxæ”¹ä¸€ä¸‹

![](http://ww1.sinaimg.cn/large/005QDhBjgy1fn5z2euvypj30vk0f0mz1.jpg)

å°†å¸¦æœ‰api çš„è¯·æ±‚éƒ½è¿›è¡Œæ‹¦æˆªï¼Œç„¶åèµ°ssppre.adbaitai.com

è¿™æ ·å°±è§£å†³äº†æœ¬åœ°è°ƒè¯•è·¨åŸŸé—®é¢˜

`ä½†æ˜¯`ï¼Œæˆ‘è¿™å‡ å¤©è‡ªå·±åœ¨æ­ä¸€ä¸ªåšå®¢ç³»ç»Ÿçš„æ—¶å€™å‘ç°è¿™ä¸ªæ–¹æ³•è¡Œä¸é€šäº†

çº³å°¼ğŸ˜±ï¼Œè¯•äº†å¾ˆå¤šæ¬¡éƒ½æ˜¯404(å› ä¸ºä¹‹å‰çš„æ–¹æ³•å¯ä»¥æ˜¯åç«¯å·²ç»åšäº†corsçš„å¤„ç†ï¼Œæ‰€ä»¥ç›´æ¥æ‹¦æˆªapiå°±å¯ä»¥å®ç°ä»£ç†)

å¾ˆå¤šäººè§‰å¾—ä¸åº”è¯¥æ˜¯æŠ¥è·¨åŸŸçš„é”™å—ï¼Œç„¶è€Œå¹¶æ²¡æœ‰ï¼Œæ˜¯404

ä¸ºä»€ä¹ˆä¼šå‡ºç°404ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™æ˜¯ä»£ç†æˆåŠŸäº†ï¼Œä¹Ÿè¯·æ±‚åˆ°äº†æˆ‘çš„æ¥å£ï¼Œè€Œä¸”æˆ‘æ¥å£æ—¥å¿—ä¸­ä¹Ÿæœ‰è¯·æ±‚æ—¥å¿—ï¼Œæ—¢ç„¶è¯·æ±‚åˆ°äº†ä¸ºä»€ä¹ˆä¼šæ˜¯404ï¼ŒåŸå› å°±æ˜¯ï¼Œä½ è¯·æ±‚æˆ‘ï¼Œä½†æ˜¯æˆ‘ä¸æƒ³ç»™ä½ æ•°æ®

è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼ˆæˆ‘å–œæ¬¢ç”¨çš„ä¸¤ç§ï¼‰ï¼š

1.æˆ‘åå°æ˜¯koa2æ­çš„ï¼Œæ‰€ä»¥æˆ‘å¼•å…¥äº†ä¸€ä¸ªæ’ä»¶â€”`koa2-cors`

```javascript
const Koa = require('koa');
const fs = require('fs');
const config = require('./config/default.js');
// const cors = require('koa2-cors');
const middlewares = require('./middlewares/middlewares.js');
const app = new Koa();
// å…·ä½“å‚æ•°æˆ‘ä»¬åœ¨åé¢è¿›è¡Œè§£é‡Š
app.use(cors({
    origin: function (ctx) {
        if (ctx.url === '/test') {
            return "*"; // å…è®¸æ¥è‡ªæ‰€æœ‰åŸŸåè¯·æ±‚
        }
        return 'http://youstde.blog.com'; // è¿™æ ·å°±èƒ½åªå…è®¸localhost:8080 è¿™ä¸ªåŸŸåçš„è¯·æ±‚äº†
    },
    exposeHeaders: ['WWW-Authenticate', 'Server-Authorization'],
    maxAge: 5,
    credentials: true,
    allowMethods: ['GET', 'POST', 'DELETE'],
    allowHeaders: ['Content-Type', 'Authorization', 'Accept'],
}));

const main = async ctx => {
	// ctx.cookies.set(
 //        'cid',
 //        'helloworld',
 //        {
 //            domain: '127.0.0.1',
 //            path: '/',
 //            maxAge: 10 * 60 * 1000,
 //            expires: new Date('2017-02-15'),  // cookieå¤±æ•ˆæ—¶é—´
 //            httpOnly: false,  // æ˜¯å¦åªç”¨äºhttpè¯·æ±‚ä¸­è·å–
 //            overwrite: false  // æ˜¯å¦å…è®¸é‡å†™
 //        }
 //    );
 //å•é¡µé¢åº”ç”¨çš„è¯ï¼Œè¿™ä¸ªæ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡
}
// app.use(require('./routers/article.js').routes());
app.use(require('./routers/sign.js').routes());
app.use(middlewares);
app.listen(config.port,()=>{
	console.log(`app is listenning on ${config.port}`);
});
```

é…ç½®ä¸€ä¸‹corse,è¿™æ ·ä¹‹å‰çš„404å°±å˜æˆäº†200äº†

![](http://ww1.sinaimg.cn/large/005QDhBjgy1fni8yj1ezfj30xu0ei0wa.jpg)

2.Nginxçš„åå‘ä»£ç†

ä¸æ˜¯ä¹‹å‰çš„é‚£ç§åšæ³•ï¼Œåªæ˜¯åšapiçš„æ‹¦æˆªï¼Œç„¶åé‡å®šå‘åˆ°æŒ‡å®šåœ°å€

æ˜¯ç»™æ¥å£åœ°å€æ–°å¼€ä¸€ä¸ªNginxé…ç½®

è‡³æ­¤ï¼Œæ¥å£ä¹Ÿä»é£˜çº¢çš„404å˜æˆäº†ç»¿è‰²çš„200äº†,å¾ˆå¼€å¿ƒ

```nginx
  server  {
        listen 80;
        server_name youstde.blog.com;

        location / {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
            proxy_set_header X-Nginx-Proxy true;
            proxy_set_header Connection "";
            proxy_pass http://localhost:8080;

         }
    }
   server  {
        listen 80;
        server_name api.youstde.blog.com;

        location / {
            add_header 'Access-Control-Allow-Origin' 'http://youstde.blog.com';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET,POST,OPTIONS';
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
            proxy_set_header X-Nginx-Proxy true;
            proxy_set_header Connection "";
            proxy_pass http://localhost:7001;

         }

    }
```

## `è¡¥å……ä¸¤ç‚¹ï¼š`

1.è·¯å¾„é‡å†™

```nginx
location ^~/cross_origin/ {
  #é‡å†™è·¯å¾„
  rewrite ^/cross_origin/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:7001/;
}
```

locationé…ç½®çš„æ„æ€æ˜¯å¯¹åŒ…å« â€œcross_originâ€ è¯·æ±‚æ‹¦æˆªï¼Œå¹¶å¯¹è¯·æ±‚è·¯å¾„è¿›è¡Œé‡å†™ï¼Œä¸€å¼€å§‹è¯·æ±‚è·¯å¾„æ˜¯ 
â€œ/cross_origin/get_json?type=20170126â€ ï¼Œé‡å†™åä¾¿æˆäº† 
â€œ/get_json?type=20170126â€ï¼Œ$1ä»£è¡¨ï¼ˆ.*ï¼‰ä¸­çš„å†…å®¹ï¼Œè€Œï¼ˆ.*ï¼‰åˆ™ä»£è¡¨ cross_origin 
åé¢çš„å…¨éƒ¨å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼šæŠŠ cross_origin éƒ¨åˆ†å»æ‰ï¼Œä½†æ˜¯ä¿ç•™ cross_origin ä¹‹åçš„æ‰€æœ‰å­—ç¬¦

2.åå‘ä»£ç†çš„æ—¶å€™çš„POSTè¯·æ±‚

æˆ‘ç”¨çš„æ˜¯axioså»åšè¯·æ±‚å¤„ç†ï¼Œä½†æ˜¯å‘é€postè¯·æ±‚çš„æ—¶å€™å‡ºç°äº†è¿™ä¸ªæƒ…å†µ

![](http://ww1.sinaimg.cn/large/005QDhBjgy1fnib3wy8a3j31iq0n4q9k.jpg)

å¾ˆæ˜¾ç„¶æ˜¯å‘é€äº†ä¸€ä¸ªé¢„è¯·æ±‚ï¼Œå› ä¸ºä¸æ˜¯ä¸€ä¸ªç®€å•çš„è¯·æ±‚

é¦–å…ˆæˆ‘ä»¬å¾—äº†è§£ä»€ä¹ˆæ˜¯ç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚

[æ–‡ç« çœ‹è¿™é‡Œ](https://segmentfault.com/a/1190000000709909)

è€Œä¸”å…³äºaxiosä¸­å¦‚ä½•å»è®¾ç½®

[çœ‹è¿™é‡Œ](https://github.com/axios/axios#using-applicationx-www-form-urlencoded-format)

![](http://ww1.sinaimg.cn/large/005QDhBjgy1fnibczvrhmj31g60tcq9f.jpg)